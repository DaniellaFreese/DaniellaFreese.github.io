<!doctype html><html itemscope itemtype=https://schema.org/WebPage class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=siteBaseUrl content="https://DaniellaFreese.github.io"><meta name=author content="danny freese"><meta name=description content="danny freese coding blog as a female software engineer."><meta name=keywords content="danny freese,female software engineer blog,coding"><meta name=generator content="Hugo 0.104.2"><title>Ansible - How to Install Docker and Connect to the Docker Daemon Immediately | Danny Freese - Coding for a Living</title><meta itemprop=name content="Ansible - How to Install Docker and Connect to the Docker Daemon Immediately"><meta itemprop=description content="Ansible - How to Install Docker and Connect to the Docker Daemon Immediately - danny freese coding blog as a female software engineer."><meta property="og:title" content="Ansible - How to Install Docker and Connect to the Docker Daemon Immediately"><meta property="og:description" content="Ansible - How to Install Docker and Connect to the Docker Daemon Immediately - danny freese coding blog as a female software engineer."><meta property="og:image" content="https://www.gravatar.com/avatar/d41d8cd98f00b204e9800998ecf8427e?size=200"><meta property="og:url" content="https://DaniellaFreese.github.io/code/ansible/ubuntu-docker/"><meta property="og:site_name" content="Danny Freese - Coding for a Living"><meta property="og:type" content="article"><script src=/modernizr-simple.js></script>
<link href=/code/ansible/ubuntu-docker/ rel=alternate type=application/rss+xml title="Danny Freese - Coding for a Living"><link href=/code/ansible/ubuntu-docker/ rel=feed type=application/rss+xml title="Danny Freese - Coding for a Living"><link rel=canonical href=https://DaniellaFreese.github.io/code/ansible/ubuntu-docker/><link rel=stylesheet href=https://DaniellaFreese.github.io/theme.css></head><body class=bilberry-hugo-theme><nav class="permanentTopNav sticky"><div class=container><ul class=topnav><li><a href=https://DaniellaFreese.github.io/page/about/>About</a></li><li><a href=https://github.com/DaniellaFreese target=_blank>Github</a></li></ul><div id=search-box class=search><i class="fas fa-search"></i>
<input id=search type=text placeholder="Search ..."></div></div></nav><header class=sticky><div class=container><div class=logo><a href=/ class=logo><img src=/images/square-modified.png alt>
<span class=overlay><i class="fa fa-home"></i></span></a></div><div class=titles><h3 class=title><a href=/>Danny Freese - Coding for a Living</a></h3><span class=subtitle>Hello World! I am constantly learning and happen to be a female software engineer. I thought it would be fun to document my thoughts, resources that help me, and journey.</span></div><div class="toggler permanentTopNav"><i class="fa fa-bars" aria-hidden=true></i></div></div></header><div class="main container"><div class="article-wrapper u-cf single"><a class=bubble href=https://DaniellaFreese.github.io/code/ansible/ubuntu-docker/><i class="fas fa-fw fa-code"></i></a><article class="default article"><div class=content><h1 class=article-title><a href=https://DaniellaFreese.github.io/code/ansible/ubuntu-docker/>Ansible - How to Install Docker and Connect to the Docker Daemon Immediately</a></h1><div class=meta><span class="date moment">2022-09-25</span>
<span class=categories><a href=https://DaniellaFreese.github.io/categories/ansible/>ansible</a></span>
<span class=author><a href=https://DaniellaFreese.github.io/author/djfreese/>djfreese</a></span></div><p><strong>Situation:</strong> I need to install docker and then the user immediately be able to reach the docker daemon with ansible.</p><p>The install steps for docker are: install processes, start/enable process, add your user to the docker group for permission to access the docker daemon, then lastly, logout and log back in to so the group membership is re-evaluated.</p><p>When building a demo with ansible, I don&rsquo;t want to have a separate playbook just to install Docker, I wanted to be able to Install Docker and immediately the user be able to run docker commands.</p><p>I was struggling with finding an ansible/non-hacky way of doing it, and found that the meta module was really convenient. With the meta module I could reset the connection as a task and immediately proceed to run any docker commands as the nonroot user. Here&rsquo;s the sample task below.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1</span><span>    <span style=color:#719e07>-</span>  name: Reset the Connection <span style=color:#719e07>for</span> <span style=color:#2aa198>&#34;{{ ansible_user }}&#34;</span> to access Docker Daemon
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2</span><span>       ansible.builtin.meta: reset_connection
</span></span></code></pre></div><p>The task itself is pretty simple. With the fully example from installing docker (in this case on ubuntu) followed by using the meta module to reset the connection is shown below.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2</span><span>    <span style=color:#719e07>-</span> name: Installing the Ubuntu Pre<span style=color:#719e07>-</span>requisites
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3</span><span>      block: 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4</span><span>        <span style=color:#719e07>-</span> name: Update Apt Cache
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5</span><span>          ansible.builtin.apt:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6</span><span>            update_cache: yes
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7</span><span>            cache_valid_time: <span style=color:#2aa198>3600</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9</span><span>        <span style=color:#719e07>-</span> name: Install Pre<span style=color:#719e07>-</span>requisite Pkgs
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10</span><span>          ansible.builtin.apt:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11</span><span>            pkg:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12</span><span>            <span style=color:#719e07>-</span> ca<span style=color:#719e07>-</span>certificates
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13</span><span>            <span style=color:#719e07>-</span> curl
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14</span><span>            <span style=color:#719e07>-</span> gnupg
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15</span><span>            <span style=color:#719e07>-</span> lsb<span style=color:#719e07>-</span>release
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16</span><span>            <span style=color:#719e07>-</span> openssl
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">17</span><span>            <span style=color:#719e07>-</span> python3<span style=color:#719e07>-</span>pip
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">19</span><span>        <span style=color:#719e07>-</span> name: Add signing key
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">20</span><span>          ansible.builtin.apt_key:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">21</span><span>            url: <span style=color:#2aa198>&#34;https://download.docker.com/linux/ubuntu/gpg&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">22</span><span>            state: present
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">23</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">24</span><span>        <span style=color:#719e07>-</span> name: Add repository into sources list
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">25</span><span>          ansible.builtin.apt_repository:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">26</span><span>            repo: <span style=color:#2aa198>&#34;deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">27</span><span>            state: present
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">28</span><span>            filename: docker
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">29</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">30</span><span>        <span style=color:#719e07>-</span> name: Install Docker
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">31</span><span>          ansible.builtin.apt:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">32</span><span>            pkg: 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">33</span><span>            <span style=color:#719e07>-</span> docker<span style=color:#719e07>-</span>ce
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">34</span><span>            <span style=color:#719e07>-</span> docker<span style=color:#719e07>-</span>ce<span style=color:#719e07>-</span>cli
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">35</span><span>            <span style=color:#719e07>-</span> containerd.io
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">36</span><span>            state: latest
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">37</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">38</span><span>        <span style=color:#719e07>-</span> name: Start Docker Process
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">39</span><span>            ansible.builtin.service:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">40</span><span>            name: docker
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">41</span><span>            state: started
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">42</span><span>            enabled: yes
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">43</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">44</span><span>        <span style=color:#719e07>-</span> name: Add <span style=color:#2aa198>&#34;{{ ansible_user }}&#34;</span> to docker group
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">45</span><span>          ansible.builtin.user:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">46</span><span>            name: <span style=color:#2aa198>&#34;{{ ansible_user }}&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">47</span><span>            groups: docker
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">48</span><span>            append: yes
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">49</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">50</span><span>        <span style=color:#719e07>-</span> name: Install Pip docker<span style=color:#719e07>-</span>py pkg
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">51</span><span>          ansible.builtin.pip:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">52</span><span>            name: docker
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">53</span><span>        become: <span style=color:#cb4b16>true</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">54</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">55</span><span>    <span style=color:#719e07>-</span>  name: Reset the Connection <span style=color:#719e07>for</span> <span style=color:#2aa198>&#34;{{ ansible_user }}&#34;</span> to access Docker Daemon
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">56</span><span>       ansible.builtin.meta: reset_connection
</span></span></code></pre></div></div><div class=footer><div class=tags><i class="fa fa-tags"></i><div class=links><a href=https://DaniellaFreese.github.io/tags/ansible/>ansible</a>
<a href=https://DaniellaFreese.github.io/tags/docker/>docker</a>
<a href=https://DaniellaFreese.github.io/tags/ubuntu/>ubuntu</a></div></div></div></article></div><div id=comments-container></div></div><footer><div class=container><div class=recent-posts><strong>Latest posts</strong><ul><li><a href=https://DaniellaFreese.github.io/code/ansible/ubuntu-docker/>Ansible - How to Install Docker and Connect to the Docker Daemon Immediately</a></li><li><a href=https://DaniellaFreese.github.io/article/mesh/understanding-envoy-proxy/>Resources for Understanding Envoy Proxy</a></li><li><a href=https://DaniellaFreese.github.io/article/openshift/fav-ocp-security-posts/>Openshift Security Best References</a></li><li><a href=https://DaniellaFreese.github.io/article/women-in-tech/>Women in Tech - Eff the Unconcious Bias</a></li><li><a href=https://DaniellaFreese.github.io/archive/>Archive page</a></li></ul></div><div class=categories><a href=/categories/><strong>Categories</strong></a><ul><li><a href=/categories/ansible>Ansible
(1)</a></li><li><a href=/categories/openshift>Openshift
(1)</a></li><li><a href=/categories/service-mesh>Service mesh
(1)</a></li><li><a href=/categories/women-in-tech>Women in tech
(1)</a></li></ul></div><div class=right><div class=external-profiles><strong>Social media</strong>
<a href=https://github.com/DaniellaFreese target=_blank><i class="fab fa-github"></i></a>
<a href=https://www.linkedin.com/in/daniellafreese/ target=_blank><i class="fab fa-linkedin"></i></a></div></div></div></footer><div class=credits><div class=container><div class=copyright><a href=https://github.com/Lednerb target=_blank>&copy;
2022
by Lednerb</a></div><div class=author><a href=https://github.com/Lednerb/bilberry-hugo-theme target=_blank>Bilberry Hugo Theme</a></div></div></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-JRGW0G2KDK"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-JRGW0G2KDK",{anonymize_ip:!1})}</script><script src=https://DaniellaFreese.github.io/theme.js></script><div id=activate-algolia-search class=hidden><input type=hidden id=algolia-search-appId value=45CEN6X6AT>
<input type=hidden id=algolia-search-apiKey value=16030625f1a4d0dd3b8aefd794fd4cf1>
<input type=hidden id=algolia-search-indexName value=bilberry-hugo-theme>
<input type=hidden id=algolia-search-noSearchResults value="Nothing found.">
<input type=hidden id=algolia-search-currentLanguageOnly></div></body></html>