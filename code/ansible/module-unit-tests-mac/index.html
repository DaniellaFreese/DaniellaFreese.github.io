<!doctype html><html itemscope itemtype=https://schema.org/WebPage class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=siteBaseUrl content="https://DaniellaFreese.github.io"><meta name=author content="danny freese"><meta name=description content="danny freese coding blog as a female software engineer."><meta name=keywords content="danny freese,female software engineer blog,coding"><meta name=generator content="Hugo 0.109.0"><title>How to Write an Ansible Module Unit Test in the Ansible Collection Paradigm | Danny Freese - Coding for a Living</title><meta itemprop=name content="How to Write an Ansible Module Unit Test in the Ansible Collection Paradigm"><meta itemprop=description content="How to Write an Ansible Module Unit Test in the Ansible Collection Paradigm - danny freese coding blog as a female software engineer."><meta property="og:title" content="How to Write an Ansible Module Unit Test in the Ansible Collection Paradigm"><meta property="og:description" content="How to Write an Ansible Module Unit Test in the Ansible Collection Paradigm - danny freese coding blog as a female software engineer."><meta property="og:image" content="https://www.gravatar.com/avatar/d41d8cd98f00b204e9800998ecf8427e?size=200"><meta property="og:url" content="https://DaniellaFreese.github.io/code/ansible/module-unit-tests-mac/"><meta property="og:site_name" content="Danny Freese - Coding for a Living"><meta property="og:type" content="article"><script src=/modernizr-simple.js></script>
<link href=/code/ansible/module-unit-tests-mac/ rel=alternate type=application/rss+xml title="Danny Freese - Coding for a Living"><link href=/code/ansible/module-unit-tests-mac/ rel=feed type=application/rss+xml title="Danny Freese - Coding for a Living"><link rel=canonical href=https://DaniellaFreese.github.io/code/ansible/module-unit-tests-mac/><link rel=stylesheet href=https://DaniellaFreese.github.io/theme.css></head><body class=bilberry-hugo-theme><nav class="permanentTopNav sticky"><div class=container><ul class=topnav><li><a href=https://DaniellaFreese.github.io/page/about/>About</a></li><li><a href=https://github.com/DaniellaFreese target=_blank>Github</a></li></ul><div id=search-box class=search><i class="fas fa-search"></i>
<input id=search type=text placeholder="Search ..."></div></div></nav><header class=sticky><div class=container><div class=logo><a href=/ class=logo><img src=/images/square-modified.png alt>
<span class=overlay><i class="fa fa-home"></i></span></a></div><div class=titles><h3 class=title><a href=/>Danny Freese - Coding for a Living</a></h3><span class=subtitle>Hello World! I am constantly learning and happen to be a female software engineer. I thought it would be fun to document my thoughts, resources that help me, and journey.</span></div><div class="toggler permanentTopNav"><i class="fa fa-bars" aria-hidden=true></i></div></div></header><div class="main container"><div class="article-wrapper u-cf single"><a class=bubble href=https://DaniellaFreese.github.io/code/ansible/module-unit-tests-mac/><i class="fas fa-fw fa-code"></i></a><article class="default article"><div class=content><h1 class=article-title><a href=https://DaniellaFreese.github.io/code/ansible/module-unit-tests-mac/>How to Write an Ansible Module Unit Test in the Ansible Collection Paradigm</a></h1><div class=meta><span class="date moment">2022-10-27</span>
<span class=categories><a href=https://DaniellaFreese.github.io/categories/ansible/>ansible</a></span>
<span class=author><a href=https://DaniellaFreese.github.io/author/djfreese/>djfreese</a></span></div><p><strong>Two major issues</strong> came up for me when it came just getting my local mac setup to write unit tests for an ansible module.</p><p><strong>First</strong> one was ansible expects a very specific file structure layout, without the <code>ansible-test</code> command would fail.</p><p><strong>Second</strong> was there is an open Docker on Mac related issue that I needed to resolve. With these two in issues resolved I could successful run some simple unit tests.</p><p>So here I will step through my setup and then the quick helloworld unit test I used to validate everything was working. This super quick tutorial assumes you have an ansible collection you are already working on.</p><h2 id=how-to-setup-your-local-env-to-develop-ansible-collections>How to Setup your Local ENV to Develop Ansible-Collections</h2><p>With ansible collections, ansible is expecting the collection to have a very specific path of <code>/ansible_collections/{collection_namespace}/{collection}</code>.</p><p>If you look in your <code>~/.ansible/collections</code> directory you&rsquo;ll find all the collections that you&rsquo;ve downloaded and maybe in use for writing actual playbooks.</p><p>The problem is unless you have the right file structure that ansible expects running the <code>ansible-tests</code> commmands fails but I did not want to contaminate my <code>.ansible</code> directory with my dev code.</p><h3 id=the-actual-setup>The Actual Setup</h3><p>To resolve the file structure concern this is my current setup:</p><p><strong>First</strong> - In my projects folder (where I typically store all my code projects) I created a new folder ansible_collections</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1</span><span>mkdir $HOME/Projects/ansible_collections/{collection_namespace}/{collection_name}
</span></span></code></pre></div><p><strong>Second</strong> - clone down the git repo to my Projects folder.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1</span><span>git clone ansible-collection-hello.git
</span></span></code></pre></div><p><strong>And Last</strong> - copied all the content into the collection_directory</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1</span><span>cp -r ansible-collection-hello/ ansible_collections/<span style=color:#719e07>{</span>collection_namespace<span style=color:#719e07>}</span>/<span style=color:#719e07>{</span>collection_name<span style=color:#719e07>}</span>/
</span></span></code></pre></div><p>With that file structure place, I could <em><strong>almost</strong></em> run <code>ansible-test units --docker -v --python 3.10</code> with no errors</p><h2 id=mac-issue>Mac Issue</h2><p>There is an open issue with Docker and Mac: <a href=https://github.com/ansible/ansible/issues/77903>https://github.com/ansible/ansible/issues/77903</a>.</p><p>I had to shut down Docker.</p><p>Open <code>~/Library/Group\ Containers/group.com.docker/settings.json</code> and update the deprecatedCgroupv1 to true: <code>"deprecatedCgroupv1": true</code></p><p>With Docker restart, the error was resolved.</p><h2 id=build-a-hello-world-module-unit-test>Build a Hello World Module Unit Test</h2><p>Within the collection, the modules are located in:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1</span><span><span style=color:#719e07>{</span>collection-name<span style=color:#719e07>}</span>/plugins/modules/<span style=color:#719e07>{</span>module-name<span style=color:#719e07>}</span>.py
</span></span></code></pre></div><p>So the unit test file structure is going to match that pattern but for testing. which will look like</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1</span><span><span style=color:#719e07>{</span>collection-name<span style=color:#719e07>}</span>/tests/unit/plugins/modules/<span style=color:#719e07>{</span>module-name<span style=color:#719e07>}</span>.py
</span></span></code></pre></div><p>But this is just the convention, you can write whatever python file name you need. So lets do a hello world unit test together.</p><h3 id=hello-world-unit-test>Hello World Unit test</h3><p><strong>First</strong> - create a helloworld.py in the modules directory:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1</span><span>mkdir my-sample-collection/tests/unit/plugins/modules/helloworld.py
</span></span></code></pre></div><p><strong>Second</strong> - open helloworld.py to write the unit test. In python we will be using the unittest package</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1</span><span><span style=color:#719e07>from</span> __future__ <span style=color:#719e07>import</span> absolute_import, division, print_function
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2</span><span>__metaclass__ <span style=color:#719e07>=</span> <span style=color:#b58900>type</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4</span><span><span style=color:#719e07>from</span> unittest <span style=color:#719e07>import</span> TestCase
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7</span><span><span style=color:#586e75># Tests Module Arguments onlys</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8</span><span><span style=color:#719e07>class</span> <span style=color:#268bd2>TestHelloworld</span>(TestCase):
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10</span><span>    <span style=color:#719e07>def</span> <span style=color:#268bd2>test_hello</span>(<span style=color:#268bd2>self</span>):
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11</span><span>        <span style=color:#268bd2>self</span><span style=color:#719e07>.</span>assertTrue(<span style=color:#cb4b16>True</span>)
</span></span></code></pre></div><p>With the <code>unittest</code> python package, any method in the classes that you want to execute as a test needs to be prefixed with <code>test_{name of test}</code>.</p><p>In the above example <code>def test_hello(self)</code>. If the function is <code>def hello(self)</code>, no dice the function will not run when the tests command is excuted.</p><p>So, save that unit test and you can now execute the following:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1</span><span>ansible-test units --docker -v --python 3.10 tests/unit/plugins/modules/helloworld.py
</span></span></code></pre></div><h3 id=next-steps>Next Steps</h3><p>So that is the basic setup for writing units testing for an ansible module that is maintained in an ansible collection.</p><p>Next you need to write an actual test for the module, and figure out how to mock the module calls.</p><p>We can talk about this in the next tutorial, but for now! Find your favorite <a href=https://github.com/ansible-collections>ansible-collection in github</a> as a reference point.</p></div><div class=footer><div class=tags><i class="fa fa-tags"></i><div class=links><a href=https://DaniellaFreese.github.io/tags/ansible/>ansible</a>
<a href=https://DaniellaFreese.github.io/tags/mac/>mac</a>
<a href=https://DaniellaFreese.github.io/tags/module/>module</a>
<a href=https://DaniellaFreese.github.io/tags/unit-test/>unit test</a></div></div></div></article></div><div id=comments-container></div></div><footer><div class=container><div class=recent-posts><strong>Latest posts</strong><ul><li><a href=https://DaniellaFreese.github.io/article/books/year-2022/>Book List of 2022 - A recap of the books read</a></li><li><a href=https://DaniellaFreese.github.io/article/openshift/fav-ocp-security-posts/>Openshift Security Best References</a></li><li><a href=https://DaniellaFreese.github.io/code/ansible/module-unit-tests-mac/>How to Write an Ansible Module Unit Test in the Ansible Collection Paradigm</a></li><li><a href=https://DaniellaFreese.github.io/article/mesh/kuma-mesh-what-is-spiffe/>What Is Spiffe and How is it used in Kuma Mesh</a></li><li><a href=https://DaniellaFreese.github.io/article/mesh/kuma-envoy-proxy-filterchains/>Kong Mesh - Understanding how Kong Mesh translates TrafficRoute Policies to Envoy Proxy Configuration</a></li><li><a href=https://DaniellaFreese.github.io/article/mesh/kuma-envoy-proxy-dive/>Kong Mesh - Tracing the Envoy Proxy Configuration</a></li><li><a href=https://DaniellaFreese.github.io/code/ansible/ubuntu-docker/>Ansible - How to Install Docker and Connect to the Docker Daemon Immediately</a></li></ul></div><div class=categories><a href=/categories/><strong>Categories</strong></a><ul><li><a href=/categories/service-mesh>Service mesh
(4)</a></li><li><a href=/categories/ansible>Ansible
(2)</a></li><li><a href=/categories/books>Books
(1)</a></li><li><a href=/categories/openshift>Openshift
(1)</a></li><li><a href=/categories/women-in-tech>Women in tech
(1)</a></li></ul></div><div class=right><div class=external-profiles><strong>Social media</strong>
<a href=https://github.com/DaniellaFreese target=_blank><i class="fab fa-github"></i></a>
<a href=https://www.linkedin.com/in/daniellafreese/ target=_blank><i class="fab fa-linkedin"></i></a></div></div></div></footer><div class=credits><div class=container><div class=copyright><a href=https://github.com/Lednerb target=_blank>&copy;
2023
by Lednerb</a></div><div class=author><a href=https://github.com/Lednerb/bilberry-hugo-theme target=_blank>Bilberry Hugo Theme</a></div></div></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-JRGW0G2KDK"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-JRGW0G2KDK",{anonymize_ip:!1})}</script><script src=https://DaniellaFreese.github.io/theme.js></script><div id=activate-algolia-search class=hidden><input type=hidden id=algolia-search-appId value=45CEN6X6AT>
<input type=hidden id=algolia-search-apiKey value=16030625f1a4d0dd3b8aefd794fd4cf1>
<input type=hidden id=algolia-search-indexName value=bilberry-hugo-theme>
<input type=hidden id=algolia-search-noSearchResults value="Nothing found.">
<input type=hidden id=algolia-search-currentLanguageOnly></div></body></html>