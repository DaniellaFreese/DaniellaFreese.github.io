<!doctype html><html itemscope itemtype=https://schema.org/WebPage class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=siteBaseUrl content="https://DaniellaFreese.github.io"><meta name=author content="danny freese"><meta name=description content="danny freese coding blog as a female software engineer."><meta name=keywords content="danny freese,female software engineer blog,coding"><meta name=generator content="Hugo 0.110.0"><title>How to Copy Secrets Between Namespaces with Kubernetes Core Ansible Collection | Danny Freese - Coding for a Living</title><meta itemprop=name content="How to Copy Secrets Between Namespaces with Kubernetes Core Ansible Collection"><meta itemprop=description content="How to Copy Secrets Between Namespaces with Kubernetes Core Ansible Collection - danny freese coding blog as a female software engineer."><meta property="og:title" content="How to Copy Secrets Between Namespaces with Kubernetes Core Ansible Collection"><meta property="og:description" content="How to Copy Secrets Between Namespaces with Kubernetes Core Ansible Collection - danny freese coding blog as a female software engineer."><meta property="og:image" content="https://www.gravatar.com/avatar/d41d8cd98f00b204e9800998ecf8427e?size=200"><meta property="og:url" content="https://DaniellaFreese.github.io/code/ansible/copy-secret-between-namespaces/"><meta property="og:site_name" content="Danny Freese - Coding for a Living"><meta property="og:type" content="article"><script src=/modernizr-simple.js></script>
<link href=/code/ansible/copy-secret-between-namespaces/ rel=alternate type=application/rss+xml title="Danny Freese - Coding for a Living"><link href=/code/ansible/copy-secret-between-namespaces/ rel=feed type=application/rss+xml title="Danny Freese - Coding for a Living"><link rel=canonical href=https://DaniellaFreese.github.io/code/ansible/copy-secret-between-namespaces/><link rel=stylesheet href=https://DaniellaFreese.github.io/theme.css></head><body class=bilberry-hugo-theme><nav class="permanentTopNav sticky"><div class=container><ul class=topnav><li><a href=https://DaniellaFreese.github.io/page/projects/>Projects</a></li><li><a href=https://DaniellaFreese.github.io/page/about/>About</a></li><li><a href=https://github.com/DaniellaFreese target=_blank>Github</a></li></ul><div id=search-box class=search><i class="fas fa-search"></i>
<input id=search type=text placeholder="Search ..."></div></div></nav><header class=sticky><div class=container><div class=logo><a href=/ class=logo><img src=/images/square-modified.png alt>
<span class=overlay><i class="fa fa-home"></i></span></a></div><div class=titles><h3 class=title><a href=/>Danny Freese - Coding for a Living</a></h3><span class=subtitle>Hello World! I am constantly learning and happen to be a female software engineer. I thought it would be fun to document my thoughts, resources that help me, and journey.</span></div><div class="toggler permanentTopNav"><i class="fa fa-bars" aria-hidden=true></i></div></div></header><div class="main container"><div class="article-wrapper u-cf single"><a class=bubble href=https://DaniellaFreese.github.io/code/ansible/copy-secret-between-namespaces/><i class="fas fa-fw fa-code"></i></a><article class="default article"><div class=content><h1 class=article-title><a href=https://DaniellaFreese.github.io/code/ansible/copy-secret-between-namespaces/>How to Copy Secrets Between Namespaces with Kubernetes Core Ansible Collection</a></h1><div class=meta><span class="date moment">2023-01-15</span>
<span class=categories><a href=https://DaniellaFreese.github.io/categories/ansible/>ansible</a></span>
<span class=author><a href=https://DaniellaFreese.github.io/author/djfreese/>djfreese</a></span></div><p>With kubectl the typical command everyone uses to copy a secret from one namespace to another is the following:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1</span><span>kubectl get secret my-token --namespace default -o yaml | sed <span style=color:#2aa198>&#39;s/namespace: .*/namespace: hello-world-namespace/&#39;</span> | kubectl apply -f -
</span></span></code></pre></div><p>It&rsquo;s a pretty straight forward, use <code>kubectl</code> get the secret as a yaml, use <code>sed</code> to replace the namespace and then <code>kubectl</code> again to apply the secret to the new namepace.</p><h3 id=problem>Problem</h3><p>In many of my playbooks I could do this same thing, as show in the sample task below:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1</span><span>- <span style=color:#268bd2>name</span>: <span style=color:#2aa198>&#34;Fetch the token secret, Copy to Namespace {{ namespace }}&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2</span><span>  <span style=color:#268bd2>shell</span>: |<span style=color:#2aa198>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3</span><span><span style=color:#2aa198>    </span>    <span style=color:#268bd2>kubectl get secret m-token --namespace default -o yaml | sed &#39;s/namespace: .*/namespace</span>: {{ namespace }}/&#39; | kubectl apply -f -
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4</span><span>  <span style=color:#268bd2>register</span>: ret
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">5</span><span>  <span style=color:#268bd2>failed_when</span>: 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">6</span><span>    - ret.rc == 1 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">7</span><span>    - <span style=color:#2aa198>&#34;&#39;error when patching&#39; not in ret.stderr&#34;</span>
</span></span></code></pre></div><p>But, the problem is now I have an external dependency to the kubectl binary, and that is not necesarily managed with ansible requirements file. So I deem this as a dependency that can easily get lost into the ether.</p><h3 id=solution>Solution</h3><p>So in order to rip out this dependency, I need to be able to the do the same thing with the kuberentes.core ansible collection.</p><p>This is what I came up with (this example happens to be a crt secret):</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1</span><span>- <span style=color:#268bd2>name</span>: <span style=color:#2aa198>&#34;Get Secret&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2</span><span>  <span style=color:#268bd2>kubernetes.core.k8s_info</span>: 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3</span><span>    <span style=color:#268bd2>kind</span>: Secret
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4</span><span>    <span style=color:#268bd2>name</span>: <span style=color:#2aa198>&#34;{{ crt_secret }}&#34;</span> 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5</span><span>    <span style=color:#268bd2>wait</span>: <span style=color:#cb4b16>yes</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6</span><span>    <span style=color:#268bd2>namespace</span>: default
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7</span><span>  <span style=color:#268bd2>register</span>: crt_resource
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9</span><span>- <span style=color:#268bd2>name</span>: <span style=color:#2aa198>&#34;Create crt_resource fact&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10</span><span>  <span style=color:#268bd2>ansible.builtin.set_fact</span>: 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11</span><span>    <span style=color:#268bd2>crt_resource </span>: <span style=color:#2aa198>&#34;{{ crt_resource.resources[0] }}&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13</span><span>- <span style=color:#268bd2>name</span>: <span style=color:#2aa198>&#34;Create Secret in new Namespace&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14</span><span>  <span style=color:#268bd2>kubernetes.core.k8s</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15</span><span>    <span style=color:#268bd2>state</span>: present
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16</span><span>    <span style=color:#268bd2>force</span>: <span style=color:#cb4b16>yes</span> 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">17</span><span>    <span style=color:#268bd2>definition</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">18</span><span>      <span style=color:#268bd2>apiVersion</span>: v1
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">19</span><span>      <span style=color:#268bd2>kind</span>: Secret
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">20</span><span>      <span style=color:#268bd2>metadata</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">21</span><span>        <span style=color:#268bd2>annotations</span>: <span style=color:#2aa198>&#34;{{ crt_resource[&#39;metadata&#39;][&#39;annotations&#39;] }}&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">22</span><span>        <span style=color:#268bd2>namespace</span>: <span style=color:#2aa198>&#34;{{ namespace }}&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">23</span><span>        <span style=color:#268bd2>name</span>: <span style=color:#2aa198>&#34;{{ crt_secret }}&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">24</span><span>      <span style=color:#268bd2>data</span>: 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">25</span><span>        <span style=color:#268bd2>tls.crt</span>: <span style=color:#2aa198>&#34;{{ crt_resource[&#39;data&#39;][&#39;tls.crt&#39;] }}&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">26</span><span>        <span style=color:#268bd2>tls.key</span>: <span style=color:#2aa198>&#34;{{ crt_resource[&#39;data&#39;][&#39;tls.key&#39;] }}&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">27</span><span>        <span style=color:#268bd2>ca.crt</span>: <span style=color:#2aa198>&#34;{{ crt_resource[&#39;data&#39;][&#39;ca.crt&#39;] }}&#34;</span>
</span></span></code></pre></div><p>Basically the steps are:</p><ul><li>register the secret as a fact</li><li>clean up the fact a bit so it&rsquo;s easier to handle</li><li>copy any data to a new secret in the new namespace</li></ul><p>In case I knew exactly what I was copying over, but if the attributes of data were to be more dynamic then you could even extend this examply furture with a jinja template to iterate and fill in the data portion of the manifest.</p><p>And that&rsquo;s it!</p><p>It may take an extra few steps but I&rsquo;ve eliminated that kubectl dependency and gives me a little more piece of mind.</p></div><div class=footer><div class=tags><i class="fa fa-tags"></i><div class=links><a href=https://DaniellaFreese.github.io/tags/ansible/>ansible</a>
<a href=https://DaniellaFreese.github.io/tags/kuberentes/>kuberentes</a>
<a href=https://DaniellaFreese.github.io/tags/kuberentes-core/>kuberentes core</a>
<a href=https://DaniellaFreese.github.io/tags/kubernetes-secrets/>kubernetes secrets</a></div></div></div></article></div><div id=comments-container></div></div><footer><div class=container><div class=recent-posts><strong>Latest posts</strong><ul><li><a href=https://DaniellaFreese.github.io/code/ansible/copy-secret-between-namespaces/>How to Copy Secrets Between Namespaces with Kubernetes Core Ansible Collection</a></li><li><a href=https://DaniellaFreese.github.io/code/ansible/kube-services/>Ansible - How to Wait for on a Kubernetes Service with the Kubernetes Core Collection</a></li><li><a href=https://DaniellaFreese.github.io/article/books/year-2022/>Book List of 2022 - A recap of the books read</a></li><li><a href=https://DaniellaFreese.github.io/article/openshift/fav-ocp-security-posts/>Openshift Security Best References</a></li><li><a href=https://DaniellaFreese.github.io/code/ansible/module-unit-tests-mac/>How to Write an Ansible Module Unit Test in the Ansible Collection Paradigm</a></li><li><a href=https://DaniellaFreese.github.io/article/mesh/kuma-mesh-what-is-spiffe/>What Is Spiffe and How is it used in Kuma Mesh</a></li><li><a href=https://DaniellaFreese.github.io/article/mesh/kuma-envoy-proxy-filterchains/>Kong Mesh - Understanding how Kong Mesh translates TrafficRoute Policies to Envoy Proxy Configuration</a></li></ul></div><div class=categories><a href=/categories/><strong>Categories</strong></a><ul><li><a href=/categories/ansible>Ansible
(4)</a></li><li><a href=/categories/service-mesh>Service mesh
(4)</a></li><li><a href=/categories/books>Books
(1)</a></li><li><a href=/categories/openshift>Openshift
(1)</a></li><li><a href=/categories/women-in-tech>Women in tech
(1)</a></li></ul></div><div class=right><div class=external-profiles><strong>Social media</strong>
<a href=https://github.com/DaniellaFreese target=_blank><i class="fab fa-github"></i></a>
<a href=https://www.linkedin.com/in/daniellafreese/ target=_blank><i class="fab fa-linkedin"></i></a></div></div></div></footer><div class=credits><div class=container><div class=copyright><a href=https://github.com/Lednerb target=_blank>&copy;
2023
by Lednerb</a></div><div class=author><a href=https://github.com/Lednerb/bilberry-hugo-theme target=_blank>Bilberry Hugo Theme</a></div></div></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-JRGW0G2KDK"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-JRGW0G2KDK",{anonymize_ip:!1})}</script><script src=https://DaniellaFreese.github.io/theme.js></script><div id=activate-algolia-search class=hidden><input type=hidden id=algolia-search-appId value=45CEN6X6AT>
<input type=hidden id=algolia-search-apiKey value=16030625f1a4d0dd3b8aefd794fd4cf1>
<input type=hidden id=algolia-search-indexName value=bilberry-hugo-theme>
<input type=hidden id=algolia-search-noSearchResults value="Nothing found.">
<input type=hidden id=algolia-search-currentLanguageOnly></div></body></html>