<!doctype html><html itemscope itemtype=https://schema.org/WebPage class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=siteBaseUrl content="https://DaniellaFreese.github.io"><meta name=author content="danny freese"><meta name=description content="danny freese coding blog as a female software engineer."><meta name=keywords content="danny freese,female software engineer blog,coding"><meta name=generator content="Hugo 0.119.0"><title>Ansible - How to Wait for on a Kubernetes Service with the Kubernetes Core Collection | Danny Freese - Coding for a Living</title><meta itemprop=name content="Ansible - How to Wait for on a Kubernetes Service with the Kubernetes Core Collection"><meta itemprop=description content="Ansible - How to Wait for on a Kubernetes Service with the Kubernetes Core Collection - danny freese coding blog as a female software engineer."><meta property="og:title" content="Ansible - How to Wait for on a Kubernetes Service with the Kubernetes Core Collection"><meta property="og:description" content="Ansible - How to Wait for on a Kubernetes Service with the Kubernetes Core Collection - danny freese coding blog as a female software engineer."><meta property="og:image" content="https://www.gravatar.com/avatar/d41d8cd98f00b204e9800998ecf8427e?size=200"><meta property="og:url" content="https://DaniellaFreese.github.io/code/ansible/kube-services/"><meta property="og:site_name" content="Danny Freese - Coding for a Living"><meta property="og:type" content="article"><script src=/modernizr-simple.js></script>
<link href=/code/ansible/kube-services/ rel=alternate type=application/rss+xml title="Danny Freese - Coding for a Living"><link href=/code/ansible/kube-services/ rel=feed type=application/rss+xml title="Danny Freese - Coding for a Living"><link rel=canonical href=https://DaniellaFreese.github.io/code/ansible/kube-services/><link rel=stylesheet href=https://DaniellaFreese.github.io/theme.css></head><body class=bilberry-hugo-theme><nav class="permanentTopNav sticky"><div class=container><ul class=topnav><li><a href=https://DaniellaFreese.github.io/page/publications/>Publications</a></li><li><a href=https://DaniellaFreese.github.io/page/about/>About</a></li><li><a href=https://DaniellaFreese.github.io/page/projects/>Projects</a></li><li><a href=https://github.com/DaniellaFreese target=_blank>Github</a></li></ul><div id=search-box class=search><i class="fas fa-search"></i>
<input id=search type=text placeholder="Search ..."></div></div></nav><header class=sticky><div class=container><div class=logo><a href=/ class=logo><img src=/images/square-modified.png alt>
<span class=overlay><i class="fa fa-home"></i></span></a></div><div class=titles><h3 class=title><a href=/>Danny Freese - Coding for a Living</a></h3><span class=subtitle>Hello World! I am constantly learning and happen to be a female software engineer. I thought it would be fun to document my thoughts, resources that help me, and journey.</span></div><div class="toggler permanentTopNav"><i class="fa fa-bars" aria-hidden=true></i></div></div></header><div class="main container"><div class="article-wrapper u-cf single"><a class=bubble href=https://DaniellaFreese.github.io/code/ansible/kube-services/><i class="fas fa-fw fa-code"></i></a><article class="default article"><div class=content><h1 class=article-title><a href=https://DaniellaFreese.github.io/code/ansible/kube-services/>Ansible - How to Wait for on a Kubernetes Service with the Kubernetes Core Collection</a></h1><div class=meta><span class="date moment">2023-01-13</span>
<span class=categories><a href=https://DaniellaFreese.github.io/categories/ansible/>ansible</a></span>
<span class=author><a href=https://DaniellaFreese.github.io/author/djfreese/>djfreese</a></span></div><p>I have been using ansible to do some demo automation in Kubernetes and Openshift. I ran into an issue where a Kubernetes Service would still not be ready for consumption even though the automation has logic to wait until the Pod Status is ready. The main problem is for a Kuberentes Service of type ClusterIP the status portion of the object is never updated. To know if the Service is ready you need to check the endpoints object, if it is populated then the service is ready.</p><h3 id=problem>Problem</h3><p>The problem I was having was after installing the cert-manager in Openshift (via Operator Hub in Openshift) is it takes a few second to boostrap the resources and the next task, dependent on the cert-manager service to be available, would fail.</p><h3 id=solution>Solution</h3><p>To resolve the problem, after installing the operator, I wait for the cert-manager related pods to be to ready, then when I execute the next task, I put it into an ansible <code>until</code> loop, register the result and retry until the task succeeds. This was a slightly lazy hackish way of not having to parse out the endpoint object each time to check.</p><p>So this solution looks like the following:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1</span><span>- <span style=color:#268bd2>name</span>: Wait for Cert Manager Pod to be Ready
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2</span><span>  <span style=color:#268bd2>kubernetes.core.k8s_info</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3</span><span>    <span style=color:#268bd2>kind</span>: Pod
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4</span><span>    <span style=color:#268bd2>api_version</span>: v1
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5</span><span>    <span style=color:#268bd2>label_selectors</span>: 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6</span><span>      - app = &#34;{{ item.label }}&#34;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7</span><span>    <span style=color:#268bd2>namespace</span>: openshift-operators
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8</span><span>    <span style=color:#268bd2>wait</span>: <span style=color:#cb4b16>yes</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9</span><span>    <span style=color:#268bd2>wait_condition</span>: 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10</span><span>      <span style=color:#268bd2>type</span>: Ready
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11</span><span>      <span style=color:#268bd2>status</span>: <span style=color:#cb4b16>True</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12</span><span>  <span style=color:#268bd2>loop</span>: 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13</span><span>    - { <span style=color:#268bd2>label</span>: <span style=color:#2aa198>&#39;cert-manager&#39;</span> }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14</span><span>    - { <span style=color:#268bd2>label</span>: <span style=color:#2aa198>&#39;webhook&#39;</span> }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15</span><span>    - { <span style=color:#268bd2>label</span>: <span style=color:#2aa198>&#39;cainjector&#39;</span> }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">17</span><span><span style=color:#586e75># cert manager configuration</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">18</span><span>- <span style=color:#268bd2>name</span>: Cert Manager Configuration
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">19</span><span>  <span style=color:#268bd2>block</span>: 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">20</span><span>    - <span style=color:#268bd2>name</span>: Create Self-Signed Issuer Configuration 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">21</span><span>      <span style=color:#268bd2>kubernetes.core.k8s</span>: 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">22</span><span>        <span style=color:#268bd2>state</span>: present
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">23</span><span>        <span style=color:#268bd2>src</span>: <span style=color:#2aa198>&#34;files/selfsigned_issuer.yaml&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">24</span><span>      <span style=color:#268bd2>register</span>: result 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">25</span><span>      <span style=color:#268bd2>until</span>: result is not failed
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">26</span><span>      <span style=color:#268bd2>retries</span>: <span style=color:#2aa198>5</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">27</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">28</span><span>    - <span style=color:#268bd2>name</span>: Wait for the SelfSigned Issuer to be Ready 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">29</span><span>      <span style=color:#268bd2>kubernetes.core.k8s_info</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">30</span><span>        <span style=color:#268bd2>api_version</span>: cert-manager.io/v1
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">31</span><span>        <span style=color:#268bd2>kind</span>: ClusterIssuer
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">32</span><span>        <span style=color:#268bd2>name</span>: selfsigned-issuer
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">33</span><span>        <span style=color:#268bd2>wait</span>: <span style=color:#cb4b16>yes</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">34</span><span>        <span style=color:#268bd2>wait_condition</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">35</span><span>          <span style=color:#268bd2>type</span>: Ready
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">36</span><span>          <span style=color:#268bd2>status</span>: <span style=color:#cb4b16>True</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">37</span><span>          <span style=color:#268bd2>reason</span>: IsReady
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">38</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">39</span><span>    - <span style=color:#268bd2>name</span>: Create CA Issuer from Self-Signed Issuer
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">40</span><span>      <span style=color:#268bd2>kubernetes.core.k8s</span>: 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">41</span><span>        <span style=color:#268bd2>state</span>: present
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">42</span><span>        <span style=color:#268bd2>src</span>: <span style=color:#2aa198>&#34;files/selfsigned_ca_issuer.yaml&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">43</span><span>      <span style=color:#268bd2>register</span>: result 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">44</span><span>      <span style=color:#268bd2>until</span>: result is not failed
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">45</span><span>      <span style=color:#268bd2>retries</span>: <span style=color:#2aa198>5</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">46</span><span>      <span style=color:#268bd2>delay</span>: <span style=color:#2aa198>10</span>
</span></span></code></pre></div><p>The End! It&rsquo;s not necessarily the most ideal solution but for the demo work I&rsquo;m doing it hasn&rsquo;t failed me yet.</p></div><div class=footer><div class=tags><i class="fa fa-tags"></i><div class=links><a href=https://DaniellaFreese.github.io/tags/ansible/>ansible</a>
<a href=https://DaniellaFreese.github.io/tags/kuberentes/>kuberentes</a>
<a href=https://DaniellaFreese.github.io/tags/kuberentes-core/>kuberentes core</a>
<a href=https://DaniellaFreese.github.io/tags/troubleshooting/>troubleshooting</a></div></div></div></article></div><div id=comments-container></div></div><footer><div class=container><div class=recent-posts><strong>Latest posts</strong><ul><li><a href=https://DaniellaFreese.github.io/code/ansible/copy-secret-between-namespaces/>How to Copy Secrets Between Namespaces with Kubernetes Core Ansible Collection</a></li><li><a href=https://DaniellaFreese.github.io/code/ansible/kube-services/>Ansible - How to Wait for on a Kubernetes Service with the Kubernetes Core Collection</a></li><li><a href=https://DaniellaFreese.github.io/article/books/year-2022/>Book List of 2022 - A recap of the books read</a></li><li><a href=https://DaniellaFreese.github.io/article/openshift/fav-ocp-security-posts/>Openshift Security Best References</a></li><li><a href=https://DaniellaFreese.github.io/code/ansible/module-unit-tests-mac/>How to Write an Ansible Module Unit Test in the Ansible Collection Paradigm</a></li><li><a href=https://DaniellaFreese.github.io/article/mesh/kuma-mesh-what-is-spiffe/>What Is Spiffe and How is it used in Kuma Mesh</a></li><li><a href=https://DaniellaFreese.github.io/article/mesh/kuma-envoy-proxy-filterchains/>Kong Mesh - Understanding how Kong Mesh translates TrafficRoute Policies to Envoy Proxy Configuration</a></li></ul></div><div class=categories><a href=/categories/><strong>Categories</strong></a><ul><li><a href=/categories/ansible>Ansible
(4)</a></li><li><a href=/categories/service-mesh>Service mesh
(4)</a></li><li><a href=/categories/books>Books
(1)</a></li><li><a href=/categories/openshift>Openshift
(1)</a></li><li><a href=/categories/women-in-tech>Women in tech
(1)</a></li></ul></div><div class=right><div class=external-profiles><strong>Social media</strong>
<a href=https://github.com/DaniellaFreese target=_blank><i class="fab fa-github"></i></a>
<a href=https://www.linkedin.com/in/daniellafreese/ target=_blank><i class="fab fa-linkedin"></i></a></div></div></div></footer><div class=credits><div class=container><div class=copyright><a href=https://github.com/Lednerb target=_blank>&copy;
2023
by Lednerb</a></div><div class=author><a href=https://github.com/Lednerb/bilberry-hugo-theme target=_blank>Bilberry Hugo Theme</a></div></div></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-JRGW0G2KDK"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-JRGW0G2KDK",{anonymize_ip:!1})}</script><script src=https://DaniellaFreese.github.io/theme.js></script><div id=activate-algolia-search class=hidden><input type=hidden id=algolia-search-appId value=45CEN6X6AT>
<input type=hidden id=algolia-search-apiKey value=16030625f1a4d0dd3b8aefd794fd4cf1>
<input type=hidden id=algolia-search-indexName value=bilberry-hugo-theme>
<input type=hidden id=algolia-search-noSearchResults value="Nothing found.">
<input type=hidden id=algolia-search-currentLanguageOnly></div></body></html>