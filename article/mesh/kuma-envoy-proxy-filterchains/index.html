<!doctype html><html itemscope itemtype=https://schema.org/WebPage class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=siteBaseUrl content="https://DaniellaFreese.github.io"><meta name=author content="danny freese"><meta name=description content="danny freese coding blog as a female software engineer."><meta name=keywords content="danny freese,female software engineer blog,coding"><meta name=generator content="Hugo 0.109.0"><title>Kong Mesh - Understanding how Kong Mesh translates TrafficRoute Policies to Envoy Proxy Configuration | Danny Freese - Coding for a Living</title><meta itemprop=name content="Kong Mesh - Understanding how Kong Mesh translates TrafficRoute Policies to Envoy Proxy Configuration"><meta itemprop=description content="Kong Mesh - Understanding how Kong Mesh translates TrafficRoute Policies to Envoy Proxy Configuration - danny freese coding blog as a female software engineer."><meta property="og:title" content="Kong Mesh - Understanding how Kong Mesh translates TrafficRoute Policies to Envoy Proxy Configuration"><meta property="og:description" content="Kong Mesh - Understanding how Kong Mesh translates TrafficRoute Policies to Envoy Proxy Configuration - danny freese coding blog as a female software engineer."><meta property="og:image" content="https://www.gravatar.com/avatar/d41d8cd98f00b204e9800998ecf8427e?size=200"><meta property="og:url" content="https://DaniellaFreese.github.io/article/mesh/kuma-envoy-proxy-filterchains/"><meta property="og:site_name" content="Danny Freese - Coding for a Living"><meta property="og:type" content="article"><script src=/modernizr-simple.js></script>
<link href=/article/mesh/kuma-envoy-proxy-filterchains/ rel=alternate type=application/rss+xml title="Danny Freese - Coding for a Living"><link href=/article/mesh/kuma-envoy-proxy-filterchains/ rel=feed type=application/rss+xml title="Danny Freese - Coding for a Living"><link rel=canonical href=https://DaniellaFreese.github.io/article/mesh/kuma-envoy-proxy-filterchains/><link rel=stylesheet href=https://DaniellaFreese.github.io/theme.css></head><body class=bilberry-hugo-theme><nav class="permanentTopNav sticky"><div class=container><ul class=topnav><li><a href=https://DaniellaFreese.github.io/page/about/>About</a></li><li><a href=https://github.com/DaniellaFreese target=_blank>Github</a></li></ul><div id=search-box class=search><i class="fas fa-search"></i>
<input id=search type=text placeholder="Search ..."></div></div></nav><header class=sticky><div class=container><div class=logo><a href=/ class=logo><img src=/images/square-modified.png alt>
<span class=overlay><i class="fa fa-home"></i></span></a></div><div class=titles><h3 class=title><a href=/>Danny Freese - Coding for a Living</a></h3><span class=subtitle>Hello World! I am constantly learning and happen to be a female software engineer. I thought it would be fun to document my thoughts, resources that help me, and journey.</span></div><div class="toggler permanentTopNav"><i class="fa fa-bars" aria-hidden=true></i></div></div></header><div class="main container"><div class="article-wrapper u-cf single"><a class=bubble href=https://DaniellaFreese.github.io/article/mesh/kuma-envoy-proxy-filterchains/><i class="fas fa-fw fa-pencil-alt"></i></a><article class="default article"><div class=content><h1 class=article-title><a href=https://DaniellaFreese.github.io/article/mesh/kuma-envoy-proxy-filterchains/>Kong Mesh - Understanding how Kong Mesh translates TrafficRoute Policies to Envoy Proxy Configuration</a></h1><div class=meta><span class="date moment">2022-10-06</span>
<span class=categories><a href=https://DaniellaFreese.github.io/categories/service-mesh/>Service Mesh</a></span>
<span class=author><a href=https://DaniellaFreese.github.io/author/djfreese/>djfreese</a></span></div><p><strong>Situation:</strong> Learning more about Kong Mesh and Envoy Proxy: I wanted to understand specifically how a Traffic Route translates to Envoy Proxy Configuration and which Sidecar Proxies.</p><p>In the previous blog I quickly ran through the configuration of a delegated gateway, and services to see all the moving parts of the Envoy Proxy Configuration. In this second blog I want to very specifically notes how the <code>Traffic Route</code> is translated to Envoy and passed down.</p><h2 id=using-jid-tooling>Using jid tooling</h2><p>The proxy configuration is pretty long, so to navigate it I&rsquo;ll be using the <code>jid</code> tool <a href=https://github.com/simeji/jid#simply-use-jid-command>jid - github</a>.</p><p><code>jid</code> has proved to be super convenient to filter through giant json data.s</p><h2 id=mesh-services-setup>Mesh Services Setup</h2><p>So I have a Kong Mesh running with three services - 1 delegated Kong Gateway, and 2 standard services.</p><p>The <code>Traffic Route</code> Policy created on the mesh is below, and it in summary states the following:</p><ul><li>if a request reaches the service <code>kong</code> and the intended destination is the <code>monolith</code> service, check if there is a url match to <code>/monolith/resources/card/dispute</code> if so, direct that request to the <code>microservice</code>, all other requests will be directed to the monolith.</li></ul><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1</span><span><span style=color:#268bd2>type</span>: TrafficRoute
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2</span><span><span style=color:#268bd2>mesh</span>: default
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3</span><span><span style=color:#268bd2>name</span>: kong-reroute
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4</span><span><span style=color:#268bd2>sources</span>: 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5</span><span>  - <span style=color:#268bd2>match</span>: 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6</span><span>      <span style=color:#268bd2>kuma.io/service</span>: kong
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7</span><span><span style=color:#268bd2>destinations</span>: 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8</span><span>  - <span style=color:#268bd2>match</span>: 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9</span><span>      <span style=color:#268bd2>kuma.io/service</span>: monolith-service_svc_5000
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10</span><span><span style=color:#268bd2>conf</span>: 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11</span><span>  <span style=color:#268bd2>destination</span>: 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12</span><span>    <span style=color:#268bd2>kuma.io/service</span>: monolith-service_svc_5000
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13</span><span>  <span style=color:#268bd2>http</span>: 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14</span><span>    - <span style=color:#268bd2>match</span>: 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15</span><span>        <span style=color:#268bd2>path</span>: 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16</span><span>          <span style=color:#268bd2>prefix</span>: /monolith/resources/card/dispute
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">17</span><span>      <span style=color:#268bd2>destination</span>: 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">18</span><span>        <span style=color:#268bd2>kuma.io/service</span>: microservice_microservice_svc_8080
</span></span></code></pre></div><h3 id=grabbing-proxy-configuration>Grabbing Proxy Configuration</h3><p>In some cases I am running kong mesh on a host, so to grab the proxy configs I am going to ssh into the box, curl the proxy admin port and keep the output in a file to dynamically filter with the jid tool:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1</span><span>curl -X GET localhost:9901/config_dump &gt; configDump.json
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3</span><span>cat configDump.json | jid
</span></span></code></pre></div><h3 id=gateway-dynamic-listners>Gateway Dynamic Listners</h3><p>Drilling down into the proxy configuration of the Gateway, it is important to note that will be a listener for each backend service, in other words a dynamic listener was generated for the <code>monolith</code> and there is a separate for the <code>microservice</code>. In order to understand how the above Traffic Route works, we need to read both listeners and more specificially the filterchain of each one.</p><h4 id=monolith-listener>Monolith Listener</h4><p>The entire filterchain is posted to avoid any ambiguity. In the filterchain we can see the HTTP Connection Manager Network Filter being used, and with it the <code>route_config</code> has the bulk of the information we are looking.</p><p>The <code>route_config</code>, and filterchains for that matter, are read in order <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/route_matching>Envoy Proxy - Route Matching</a>.</p><p>So the literal translation of the route_config is near identical to the Traffic Route policy and states: <code>analyze the traffic intended for monolith service, if it has the prefix match /monolith/resources/card/dispute direct that request to the microservice, otherwise any request matching to the url / will be sent to the monolith.</code></p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1</span><span>[Filter]&gt; .configs[2].dynamic_listeners[1].active_state.listener.filter_chains[0].filters[0]
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3</span><span>  <span style=color:#268bd2>&#34;name&#34;: </span><span style=color:#2aa198>&#34;envoy.filters.network.http_connection_manager&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4</span><span>  <span style=color:#268bd2>&#34;typed_config&#34;: </span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5</span><span>    <span style=color:#268bd2>&#34;@type&#34;: </span><span style=color:#2aa198>&#34;type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6</span><span>    <span style=color:#268bd2>&#34;common_http_protocol_options&#34;: </span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7</span><span>      <span style=color:#268bd2>&#34;idle_timeout&#34;: </span><span style=color:#2aa198>&#34;3600s&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8</span><span>    },
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9</span><span>    <span style=color:#268bd2>&#34;http_filters&#34;: </span>[
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10</span><span>      {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11</span><span>        <span style=color:#268bd2>&#34;name&#34;: </span><span style=color:#2aa198>&#34;envoy.filters.http.router&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12</span><span>        <span style=color:#268bd2>&#34;typed_config&#34;: </span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13</span><span>          <span style=color:#268bd2>&#34;@type&#34;: </span><span style=color:#2aa198>&#34;type.googleapis.com/envoy.extensions.filters.http.router.v3.Router&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15</span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16</span><span>    ],
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">17</span><span>    <span style=color:#268bd2>&#34;route_config&#34;: </span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">18</span><span>      <span style=color:#268bd2>&#34;name&#34;: </span><span style=color:#2aa198>&#34;outbound:monolith-service_svc_5000&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">19</span><span>      <span style=color:#268bd2>&#34;request_headers_to_add&#34;: </span>[
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">20</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">21</span><span>          <span style=color:#268bd2>&#34;header&#34;: </span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">22</span><span>            <span style=color:#268bd2>&#34;key&#34;: </span><span style=color:#2aa198>&#34;x-kuma-tags&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">23</span><span>            <span style=color:#268bd2>&#34;value&#34;: </span><span style=color:#2aa198>&#34;\u0026kuma.io/service=kong\u0026\u0026kuma.io/zone=on_prem\u0026&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">24</span><span>          }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">25</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">26</span><span>      ],
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">27</span><span>      <span style=color:#268bd2>&#34;validate_clusters&#34;: </span><span style=color:#cb4b16>false</span>,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">28</span><span>      <span style=color:#268bd2>&#34;virtual_hosts&#34;: </span>[
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">29</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">30</span><span>          <span style=color:#268bd2>&#34;domains&#34;: </span>[
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">31</span><span>             <span style=color:#2aa198>&#34;*&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">32</span><span>          ],
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">33</span><span>          <span style=color:#268bd2>&#34;name&#34;: </span><span style=color:#2aa198>&#34;monolith-service_svc_5000&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">34</span><span>          <span style=color:#268bd2>&#34;retry_policy&#34;: </span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">35</span><span>            <span style=color:#268bd2>&#34;num_retries&#34;: </span><span style=color:#2aa198>5</span>,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">36</span><span>            <span style=color:#268bd2>&#34;per_try_timeout&#34;: </span><span style=color:#2aa198>&#34;16s&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">37</span><span>            <span style=color:#268bd2>&#34;retry_back_off&#34;: </span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">38</span><span>              <span style=color:#268bd2>&#34;base_interval&#34;: </span><span style=color:#2aa198>&#34;0.025s&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">39</span><span>              <span style=color:#268bd2>&#34;max_interval&#34;: </span><span style=color:#2aa198>&#34;0.250s&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">40</span><span>            },
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">41</span><span>            <span style=color:#268bd2>&#34;retry_on&#34;: </span><span style=color:#2aa198>&#34;gateway-error,connect-failure,refused-stream&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">42</span><span>          },
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">43</span><span>          <span style=color:#268bd2>&#34;routes&#34;: </span>[
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">44</span><span>            {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">45</span><span>              <span style=color:#268bd2>&#34;match&#34;: </span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">46</span><span>                <span style=color:#268bd2>&#34;prefix&#34;: </span><span style=color:#2aa198>&#34;/monolith/resources/card/dispute&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">47</span><span>              },
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">48</span><span>              <span style=color:#268bd2>&#34;route&#34;: </span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">49</span><span>                <span style=color:#268bd2>&#34;cluster&#34;: </span><span style=color:#2aa198>&#34;microservice_microservice_svc_8080&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">50</span><span>                <span style=color:#268bd2>&#34;timeout&#34;: </span><span style=color:#2aa198>&#34;15s&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">51</span><span>              }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">52</span><span>            },
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">53</span><span>            {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">54</span><span>              <span style=color:#268bd2>&#34;match&#34;: </span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">55</span><span>                <span style=color:#268bd2>&#34;prefix&#34;: </span><span style=color:#2aa198>&#34;/&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">56</span><span>              },
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">57</span><span>              <span style=color:#268bd2>&#34;route&#34;: </span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">58</span><span>                <span style=color:#268bd2>&#34;cluster&#34;: </span><span style=color:#2aa198>&#34;monolith-service_svc_5000&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">59</span><span>                <span style=color:#268bd2>&#34;timeout&#34;: </span><span style=color:#2aa198>&#34;15s&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">60</span><span>              }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">61</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">62</span><span>          ]
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">63</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">64</span><span>      ]
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">65</span><span>    },
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">66</span><span>    <span style=color:#268bd2>&#34;stat_prefix&#34;: </span><span style=color:#2aa198>&#34;monolith-service_svc_5000&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">67</span><span>    <span style=color:#268bd2>&#34;stream_idle_timeout&#34;: </span><span style=color:#2aa198>&#34;1800s&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">68</span><span>  }
</span></span></code></pre></div><h3 id=microservice-filterchain>Microservice Filterchain</h3><p>Following up with the listener and filter chain for the microservice. The entire listener is provided below because it was not as dense.</p><p>The most valuable takeway from the sample below is the filterchain object is empty. Hence, all the logic for the sample Traffic Route is being driven gateway envoy proxy in the listener assigned to the monolith, which makes sense, because the policy defines:</p><ul><li><p><strong>First</strong> the <code>source</code> - i.e. the <code>gateway</code></p></li><li><p><strong>Second</strong> the <code>destination</code> - i.e. the <code>listener</code> defined on the source</p></li></ul><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1</span><span>[Filter]&gt; .configs[2].dynamic_listeners[2]                                                  
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3</span><span>  <span style=color:#268bd2>&#34;active_state&#34;: </span>{                                                
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4</span><span>    <span style=color:#268bd2>&#34;last_updated&#34;: </span><span style=color:#2aa198>&#34;2022-10-10T15:30:37.010Z&#34;</span>,             
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5</span><span>    <span style=color:#268bd2>&#34;listener&#34;: </span>{                                                                                                    
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6</span><span>      <span style=color:#268bd2>&#34;@type&#34;: </span><span style=color:#2aa198>&#34;type.googleapis.com/envoy.config.listener.v3.Listener&#34;</span>,                                                
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7</span><span>      <span style=color:#268bd2>&#34;address&#34;: </span>{                                                                                                       
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8</span><span>        <span style=color:#268bd2>&#34;socket_address&#34;: </span>{                                                                                                
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9</span><span>          <span style=color:#268bd2>&#34;address&#34;: </span><span style=color:#2aa198>&#34;127.0.0.1&#34;</span>,          
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10</span><span>          <span style=color:#268bd2>&#34;port_value&#34;: </span><span style=color:#2aa198>33034</span>      
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11</span><span>        }                                   
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12</span><span>      },                                      
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13</span><span>      <span style=color:#268bd2>&#34;filter_chains&#34;: </span>[                                                               
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14</span><span>        {}                                                                               
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15</span><span>      ],                                                                                   
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16</span><span>      <span style=color:#268bd2>&#34;metadata&#34;: </span>{                                                                                                          
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">17</span><span>        <span style=color:#268bd2>&#34;filter_metadata&#34;: </span>{                                          
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">18</span><span>          <span style=color:#268bd2>&#34;io.kuma.tags&#34;: </span>{                                                                                                    
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">19</span><span>            <span style=color:#268bd2>&#34;kuma.io/service&#34;: </span><span style=color:#2aa198>&#34;microservice_microservice_svc_8080&#34;</span>                                                              
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">20</span><span>          }                                            
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">21</span><span>        }                                                                                                                          
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">22</span><span>      },                                            
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">23</span><span>      <span style=color:#268bd2>&#34;name&#34;: </span><span style=color:#2aa198>&#34;outbound:127.0.0.1:33034&#34;</span>,                                              
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">24</span><span>      <span style=color:#268bd2>&#34;traffic_direction&#34;: </span><span style=color:#2aa198>&#34;OUTBOUND&#34;</span>                                                          
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">25</span><span>    },                                                                                     
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">26</span><span>    <span style=color:#268bd2>&#34;version_info&#34;: </span><span style=color:#2aa198>&#34;f9eb4f12-c266-4cda-9932-16a67ecaeb0a&#34;</span>                                           
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">27</span><span>  },                                                                                               
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">28</span><span>  <span style=color:#268bd2>&#34;name&#34;: </span><span style=color:#2aa198>&#34;outbound:127.0.0.1:33034&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">29</span><span>}
</span></span></code></pre></div><h2 id=thats-all-folks>That&rsquo;s all Folks</h2><p>And that&rsquo;s all folks. I like doing these little snippets just to do some quick concept validation and start the process of demystifying enovy proxy. The key takeway here is a lot of the cool traffic management features of Kong Mesh are present in the filter chains of <code>source</code> defined in the <code>Traffic Route</code>.</p></div><div class=footer><div class=tags><i class="fa fa-tags"></i><div class=links><a href=https://DaniellaFreese.github.io/tags/service-mesh/>service mesh</a>
<a href=https://DaniellaFreese.github.io/tags/kong-mesh/>Kong Mesh</a>
<a href=https://DaniellaFreese.github.io/tags/kuma/>Kuma</a>
<a href=https://DaniellaFreese.github.io/tags/envoy-proxy/>Envoy Proxy</a></div></div></div></article></div><div id=comments-container></div></div><footer><div class=container><div class=recent-posts><strong>Latest posts</strong><ul><li><a href=https://DaniellaFreese.github.io/code/ansible/copy-secret-between-namespaces/>How to Copy Secrets Between Namespaces with Kubernetes Core Ansible Collection</a></li><li><a href=https://DaniellaFreese.github.io/code/ansible/kube-services/>Ansible - How to Wait for on a Kubernetes Service with the Kubernetes Core Collection</a></li><li><a href=https://DaniellaFreese.github.io/article/books/year-2022/>Book List of 2022 - A recap of the books read</a></li><li><a href=https://DaniellaFreese.github.io/article/openshift/fav-ocp-security-posts/>Openshift Security Best References</a></li><li><a href=https://DaniellaFreese.github.io/code/ansible/module-unit-tests-mac/>How to Write an Ansible Module Unit Test in the Ansible Collection Paradigm</a></li><li><a href=https://DaniellaFreese.github.io/article/mesh/kuma-mesh-what-is-spiffe/>What Is Spiffe and How is it used in Kuma Mesh</a></li><li><a href=https://DaniellaFreese.github.io/article/mesh/kuma-envoy-proxy-filterchains/>Kong Mesh - Understanding how Kong Mesh translates TrafficRoute Policies to Envoy Proxy Configuration</a></li></ul></div><div class=categories><a href=/categories/><strong>Categories</strong></a><ul><li><a href=/categories/ansible>Ansible
(4)</a></li><li><a href=/categories/service-mesh>Service mesh
(4)</a></li><li><a href=/categories/books>Books
(1)</a></li><li><a href=/categories/openshift>Openshift
(1)</a></li><li><a href=/categories/women-in-tech>Women in tech
(1)</a></li></ul></div><div class=right><div class=external-profiles><strong>Social media</strong>
<a href=https://github.com/DaniellaFreese target=_blank><i class="fab fa-github"></i></a>
<a href=https://www.linkedin.com/in/daniellafreese/ target=_blank><i class="fab fa-linkedin"></i></a></div></div></div></footer><div class=credits><div class=container><div class=copyright><a href=https://github.com/Lednerb target=_blank>&copy;
2023
by Lednerb</a></div><div class=author><a href=https://github.com/Lednerb/bilberry-hugo-theme target=_blank>Bilberry Hugo Theme</a></div></div></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-JRGW0G2KDK"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-JRGW0G2KDK",{anonymize_ip:!1})}</script><script src=https://DaniellaFreese.github.io/theme.js></script><div id=activate-algolia-search class=hidden><input type=hidden id=algolia-search-appId value=45CEN6X6AT>
<input type=hidden id=algolia-search-apiKey value=16030625f1a4d0dd3b8aefd794fd4cf1>
<input type=hidden id=algolia-search-indexName value=bilberry-hugo-theme>
<input type=hidden id=algolia-search-noSearchResults value="Nothing found.">
<input type=hidden id=algolia-search-currentLanguageOnly></div></body></html>